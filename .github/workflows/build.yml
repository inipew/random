name: build-dnscrypt-proxy-and-caddy

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_target:
        description: "Build target: dnscrypt | caddy | both"
        type: choice
        required: false
        default: both
        options:
          - dnscrypt
          - caddy
          - both

      version:
        description: "Label versi untuk release"
        required: false
        default: ""

      release_tag:
        description: "Tag release (opsional)"
        required: false
        default: ""

      caddy_ref:
        description: "Caddy ref (branch/tag/full 40 SHA)"
        required: false
        default: ""

      goamd64:
        description: "GOAMD64 level"
        type: choice
        required: false
        default: v1
        options:
          - auto
          - v1
          - v2
          - v3
          - v4

      prerelease:
        type: boolean
        default: false

      draft:
        type: boolean
        default: false

permissions:
  contents: write

jobs:

# =========================
# META
# =========================

  meta:
    runs-on: ubuntu-latest
    outputs:
      version_label: ${{ steps.meta.outputs.version_label }}
      release_tag: ${{ steps.meta.outputs.release_tag }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
      is_draft: ${{ steps.meta.outputs.is_draft }}
      goamd64: ${{ steps.meta.outputs.goamd64 }}
      build_target: ${{ steps.meta.outputs.build_target }}
      dns_sha: ${{ steps.meta.outputs.dns_sha }}
      dns_sha_full: ${{ steps.meta.outputs.dns_sha_full }}
      dns_tar_name: ${{ steps.meta.outputs.dns_tar_name }}
      caddy_sha: ${{ steps.meta.outputs.caddy_sha }}
      caddy_sha_full: ${{ steps.meta.outputs.caddy_sha_full }}
      caddy_tar_name: ${{ steps.meta.outputs.caddy_tar_name }}

    steps:
      - name: Compute metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          BUILD_TARGET="${{ github.event.inputs.build_target }}"
          [[ -z "$BUILD_TARGET" ]] && BUILD_TARGET="both"

          case "$BUILD_TARGET" in
            dnscrypt|caddy|both) ;;
            *) echo "Invalid build_target"; exit 1 ;;
          esac

          # dnscrypt commit
          git clone --depth=1 https://github.com/DNSCrypt/dnscrypt-proxy src
          DNS_SHA_FULL="$(git -C src rev-parse HEAD)"
          DNS_SHA="${DNS_SHA_FULL:0:7}"

          # resolve caddy commit
          CADDY_REF="${{ github.event.inputs.caddy_ref }}"
          [[ -z "$CADDY_REF" ]] && CADDY_REF="HEAD"

          CADDY_SHA_FULL="$(git ls-remote https://github.com/caddyserver/caddy "$CADDY_REF" | head -n1 | awk '{print $1}')"
          CADDY_SHA="${CADDY_SHA_FULL:0:7}"

          # GOAMD64
          INPUT_GOAMD64="${{ github.event.inputs.goamd64 }}"
          [[ -z "$INPUT_GOAMD64" ]] && INPUT_GOAMD64="auto"

          if [[ "$INPUT_GOAMD64" == "auto" ]]; then
            GOAMD64="v1"
          else
            GOAMD64="$INPUT_GOAMD64"
          fi

          VERSION_INPUT="${{ github.event.inputs.version }}"
          [[ -z "$VERSION_INPUT" ]] && VERSION_INPUT="manual"

          RELEASE_TAG_INPUT="${{ github.event.inputs.release_tag }}"
          [[ -z "$RELEASE_TAG_INPUT" ]] && RELEASE_TAG_INPUT="manual-dns_${DNS_SHA}-caddy_${CADDY_SHA}"

          DNS_TAR="dnscrypt-proxy-${VERSION_INPUT}-up_${DNS_SHA}-linux-amd64-goamd64${GOAMD64}.tar.gz"
          CADDY_TAR="caddy-${VERSION_INPUT}-up_${CADDY_SHA}-linux-amd64-goamd64${GOAMD64}.tar.gz"

          {
            echo "build_target=$BUILD_TARGET"
            echo "version_label=$VERSION_INPUT"
            echo "release_tag=$RELEASE_TAG_INPUT"
            echo "is_prerelease=${{ github.event.inputs.prerelease }}"
            echo "is_draft=${{ github.event.inputs.draft }}"
            echo "goamd64=$GOAMD64"
            echo "dns_sha=$DNS_SHA"
            echo "dns_sha_full=$DNS_SHA_FULL"
            echo "dns_tar_name=$DNS_TAR"
            echo "caddy_sha=$CADDY_SHA"
            echo "caddy_sha_full=$CADDY_SHA_FULL"
            echo "caddy_tar_name=$CADDY_TAR"
          } >> $GITHUB_OUTPUT

# =========================
# BUILD DNSCRYPT
# =========================

  build_dnscrypt:
    if: ${{ needs.meta.outputs.build_target == 'dnscrypt' || needs.meta.outputs.build_target == 'both' }}
    runs-on: ubuntu-latest
    needs: meta
    env:
      GOOS: linux
      GOARCH: amd64
      GOAMD64: ${{ needs.meta.outputs.goamd64 }}
      CGO_ENABLED: "0"

    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Build dnscrypt
        run: |
          git clone https://github.com/DNSCrypt/dnscrypt-proxy src
          cd src/dnscrypt-proxy
          git checkout ${{ needs.meta.outputs.dns_sha_full }}
          go build -ldflags="-s -w" -o dnscrypt-proxy
          mkdir -p ../../release_assets
          cp dnscrypt-proxy ../../release_assets/
          cd ../../release_assets
          tar -czf "${{ needs.meta.outputs.dns_tar_name }}" dnscrypt-proxy

      - uses: actions/upload-artifact@v4
        with:
          name: release_assets_dnscrypt
          path: release_assets/*

# =========================
# BUILD CADDY
# =========================

  build_caddy:
    if: ${{ needs.meta.outputs.build_target == 'caddy' || needs.meta.outputs.build_target == 'both' }}
    runs-on: ubuntu-latest
    needs: meta
    env:
      GOOS: linux
      GOARCH: amd64
      GOAMD64: ${{ needs.meta.outputs.goamd64 }}
      CGO_ENABLED: "0"

    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build caddy
        run: |
          mkdir -p release_assets
          xcaddy build "${{ needs.meta.outputs.caddy_sha_full }}" \
            --output release_assets/caddy
          cd release_assets
          tar -czf "${{ needs.meta.outputs.caddy_tar_name }}" caddy

      - uses: actions/upload-artifact@v4
        with:
          name: release_assets_caddy
          path: release_assets/*

# =========================
# RELEASE
# =========================

  release:
    if: always()
    needs: [meta, build_dnscrypt, build_caddy]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Flatten artifacts
        run: |
          mkdir final
          find release_assets -type f -exec cp {} final/ \;
          cd final
          sha256sum * > SHA256SUMS

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.release_tag }}
          name: custom build ${{ needs.meta.outputs.version_label }}
          prerelease: ${{ needs.meta.outputs.is_prerelease == 'true' }}
          draft: ${{ needs.meta.outputs.is_draft == 'true' }}
          files: final/*