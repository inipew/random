name: build-dnscrypt-proxy-and-caddy

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      build_target:
        description: "dnscrypt | caddy | both"
        type: choice
        default: both
        options: [dnscrypt, caddy, both]

      version:
        description: "Version label"
        required: false

      release_tag:
        description: "Release tag"
        required: false

      caddy_ref:
        description: "Caddy branch/tag/full SHA"
        required: false

      goamd64:
        description: "GOAMD64 level"
        type: choice
        default: auto
        options: [auto, v1, v2, v3, v4]

      prerelease:
        type: boolean
        default: false

      draft:
        type: boolean
        default: false

permissions:
  contents: write

# =========================================================
# META (lightweight, no full clone)
# =========================================================

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      build_target: ${{ steps.meta.outputs.build_target }}
      goamd64: ${{ steps.meta.outputs.goamd64 }}
      version_label: ${{ steps.meta.outputs.version_label }}
      release_tag: ${{ steps.meta.outputs.release_tag }}
      prerelease: ${{ steps.meta.outputs.prerelease }}
      draft: ${{ steps.meta.outputs.draft }}
      dns_sha: ${{ steps.meta.outputs.dns_sha }}
      caddy_sha: ${{ steps.meta.outputs.caddy_sha }}
      dns_tar: ${{ steps.meta.outputs.dns_tar }}
      caddy_tar: ${{ steps.meta.outputs.caddy_tar }}

    steps:
      - id: meta
        shell: bash
        run: |
          set -euo pipefail

          BUILD_TARGET="${{ github.event.inputs.build_target }}"
          [[ -z "$BUILD_TARGET" ]] && BUILD_TARGET="both"

          # Resolve latest dnscrypt commit (no clone)
          DNS_SHA_FULL="$(git ls-remote https://github.com/DNSCrypt/dnscrypt-proxy HEAD | awk '{print $1}')"
          DNS_SHA="${DNS_SHA_FULL:0:7}"

          # Resolve caddy commit
          CADDY_REF="${{ github.event.inputs.caddy_ref }}"
          [[ -z "$CADDY_REF" ]] && CADDY_REF="HEAD"
          CADDY_SHA_FULL="$(git ls-remote https://github.com/caddyserver/caddy "$CADDY_REF" | head -n1 | awk '{print $1}')"
          CADDY_SHA="${CADDY_SHA_FULL:0:7}"

          # GOAMD64
          INPUT_GOAMD64="${{ github.event.inputs.goamd64 }}"
          if [[ "$INPUT_GOAMD64" == "auto" || -z "$INPUT_GOAMD64" ]]; then
            GOAMD64="v1"
          else
            GOAMD64="$INPUT_GOAMD64"
          fi

          VERSION="${{ github.event.inputs.version }}"
          [[ -z "$VERSION" ]] && VERSION="manual"

          RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          [[ -z "$RELEASE_TAG" ]] && RELEASE_TAG="manual-dns_${DNS_SHA}-caddy_${CADDY_SHA}"

          DNS_TAR="dnscrypt-${VERSION}-up_${DNS_SHA}-goamd64${GOAMD64}.tar.gz"
          CADDY_TAR="caddy-${VERSION}-up_${CADDY_SHA}-goamd64${GOAMD64}.tar.gz"

          {
            echo "build_target=$BUILD_TARGET"
            echo "goamd64=$GOAMD64"
            echo "version_label=$VERSION"
            echo "release_tag=$RELEASE_TAG"
            echo "prerelease=${{ github.event.inputs.prerelease }}"
            echo "draft=${{ github.event.inputs.draft }}"
            echo "dns_sha=$DNS_SHA_FULL"
            echo "caddy_sha=$CADDY_SHA_FULL"
            echo "dns_tar=$DNS_TAR"
            echo "caddy_tar=$CADDY_TAR"
          } >> $GITHUB_OUTPUT

# =========================================================
# DNSCRYPT BUILD (only if needed)
# =========================================================

  build_dnscrypt:
    if: ${{ needs.meta.outputs.build_target == 'dnscrypt' || needs.meta.outputs.build_target == 'both' }}
    needs: meta
    runs-on: ubuntu-latest

    env:
      GOOS: linux
      GOARCH: amd64
      GOAMD64: ${{ needs.meta.outputs.goamd64 }}
      CGO_ENABLED: "0"

    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Clone specific commit
        run: |
          git clone --depth=1 https://github.com/DNSCrypt/dnscrypt-proxy src
          git -C src fetch --depth=1 origin "${{ needs.meta.outputs.dns_sha }}"
          git -C src checkout "${{ needs.meta.outputs.dns_sha }}"

      - name: Build
        run: |
          cd src/dnscrypt-proxy
          go build -trimpath -ldflags="-s -w" -o dnscrypt-proxy
          mkdir -p ../../release
          cp dnscrypt-proxy ../../release/
          cd ../../release
          tar -czf "${{ needs.meta.outputs.dns_tar }}" dnscrypt-proxy

      - uses: actions/upload-artifact@v4
        with:
          name: dnscrypt
          path: release/*

# =========================================================
# CADDY BUILD (only if needed)
# =========================================================

  build_caddy:
    if: ${{ needs.meta.outputs.build_target == 'caddy' || needs.meta.outputs.build_target == 'both' }}
    needs: meta
    runs-on: ubuntu-latest

    env:
      GOOS: linux
      GOARCH: amd64
      GOAMD64: ${{ needs.meta.outputs.goamd64 }}
      CGO_ENABLED: "0"

    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build
        run: |
          mkdir release
          xcaddy build "${{ needs.meta.outputs.caddy_sha }}" \
            --output release/caddy \
            --with github.com/mholt/caddy-l4 \
            --with github.com/WeidiDeng/caddy-cloudflare-ip \
            --with github.com/caddy-dns/cloudflare
          cd release
          tar -czf "${{ needs.meta.outputs.caddy_tar }}" caddy

      - uses: actions/upload-artifact@v4
        with:
          name: caddy
          path: release/*

# =========================================================
# RELEASE
# =========================================================

  release:
    if: always()
    needs: [meta, build_dnscrypt, build_caddy]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Flatten & checksum
        run: |
          mkdir final
          find artifacts -type f -exec cp {} final/ \;
          cd final
          sha256sum * > SHA256SUMS

      - name: Generate dynamic release notes
        run: |
          echo "Custom build" > notes.md
          echo "" >> notes.md

          if ls final/dnscrypt* 1>/dev/null 2>&1; then
            echo "### dnscrypt-proxy" >> notes.md
            echo "- Commit: ${{ needs.meta.outputs.dns_sha }}" >> notes.md
            echo "" >> notes.md
          fi

          if ls final/caddy* 1>/dev/null 2>&1; then
            echo "### Caddy" >> notes.md
            echo "- Commit: ${{ needs.meta.outputs.caddy_sha }}" >> notes.md
            echo "" >> notes.md
          fi

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.release_tag }}
          name: custom build ${{ needs.meta.outputs.version_label }}
          body_path: notes.md
          prerelease: ${{ needs.meta.outputs.prerelease == 'true' }}
          draft: ${{ needs.meta.outputs.draft == 'true' }}
          files: final/*